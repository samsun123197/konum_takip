<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konum Uygulamam | PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { 
            --primary: #2563eb; 
            --secondary: #10b981; 
            --bg: #f1f5f9;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 15px;
            display: flex; 
            flex-direction: column; 
            align-items: center;
        }

        .app-card {
            background: white; 
            padding: 20px; 
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            width: 100%; 
            max-width: 600px;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #1e293b; }
        .header p { color: #64748b; font-size: 0.9rem; margin-top: 5px; }

        .btn-group { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 20px; 
        }

        button {
            padding: 14px; 
            border: none; 
            border-radius: 12px; 
            color: white;
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-view { background-color: var(--primary); }
        .btn-send { background-color: var(--secondary); }
        button:active { transform: scale(0.97); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #map { 
            height: 350px; 
            width: 100%; 
            border-radius: 15px; 
            border: 1px solid #e2e8f0;
            z-index: 1;
        }

        .info-box {
            margin-top: 15px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            font-size: 0.85rem;
            color: #334155;
            line-height: 1.5;
        }

        .label { font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="app-card">
    <div class="header">
        <h2>üìç Konum Servisi</h2>
        <p>Hƒ±zlƒ±, g√ºvenli ve kolay konum payla≈üƒ±mƒ±</p>
    </div>

    <div class="btn-group">
        <button class="btn-view" onclick="startTracking()">
            üîç Konumu Bul
        </button>
        <button class="btn-send" id="sendBtn" onclick="shareLocation()" disabled>
            ‚ÜóÔ∏è Payla≈ü
        </button>
    </div>

    <div id="map"></div>

    <div class="info-box">
        <div><span class="label">Durum:</span> <span id="status">Hazƒ±r</span></div>
        <div><span class="label">Adres:</span> <span id="address">Konum bekleniyor...</span></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. PWA Service Worker Kaydƒ±
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Hata:', err));
        });
    }

    // 2. Harita Ba≈ülatma (T√ºrkiye Odaklƒ±)
    let map = L.map('map').setView([38.9637, 35.2433], 6);
    let marker, circle;
    let userCoords = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // 3. Adres Bilgisini Getirme (Reverse Geocoding)
    async function updateAddress(lat, lng) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
            const data = await res.json();
            document.getElementById('address').innerText = data.display_name || "Adres bulunamadƒ±.";
        } catch (e) {
            document.getElementById('address').innerText = "Adres servisi ≈üu an kullanƒ±lamƒ±yor.";
        }
    }

    // 4. Canlƒ± Konum Takibi
    function startTracking() {
        if (!navigator.geolocation) {
            alert("Cihazƒ±nƒ±z konum √∂zelliƒüini desteklemiyor.");
            return;
        }

        document.getElementById('status').innerText = "Aranƒ±yor...";

        navigator.geolocation.watchPosition((pos) => {
            const { latitude, longitude, accuracy } = pos.coords;
            userCoords = { lat: latitude, lng: longitude };

            // Harita g√ºncelleme
            map.setView([latitude, longitude], 16);
            
            if (marker) map.removeLayer(marker);
            if (circle) map.removeLayer(circle);

            marker = L.marker([latitude, longitude]).addTo(map).bindPopup("Buradasƒ±nƒ±z").openPopup();
            circle = L.circle([latitude, longitude], { radius: accuracy, color: '#2563eb' }).addTo(map);

            document.getElementById('status').innerText = "Konum Alƒ±ndƒ± ‚úÖ";
            document.getElementById('sendBtn').disabled = false;
            
            updateAddress(latitude, longitude);
        }, (err) => {
            document.getElementById('status').innerText = "Hata: " + err.message;
        }, { enableHighAccuracy: true });
    }

    // 5. WhatsApp √úzerinden Payla≈üƒ±m
    function shareLocation() {
        if (userCoords) {
            const url = `https://www.google.com/maps?q=${userCoords.lat},${userCoords.lng}`;
            const text = `≈ûu anki konumum: ${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
    }
</script>

</body>
</html>
